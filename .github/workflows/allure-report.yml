name: Run Tests and Publish Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT: product            # top-level folder on gh-pages
  MODULE:  api                # sub-folder (api, app, web, â€¦)
  KEEP:    20                 # how many past reports to retain
  PYTHON:  "3.10"

permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Checkout source â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Python & deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Run tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run tests
        run: |
          pytest tests/ -v --alluredir=allure-results

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Pull previous history (if any) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout gh-pages for history
        if: always()
        continue-on-error: true          # first run has no history
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
      - name: Copy last-history into results
        if: always()
        run: |
          HIST_PATH="gh-pages/${{ env.PROJECT }}/${{ env.MODULE }}/allure-history/last-history"
          mkdir -p allure-results/history
          [ -d "$HIST_PATH" ] && cp -r "$HIST_PATH/." allure-results/history || echo "No previous history"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Build report & rotate history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Allure report
        if: always()
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: allure-results
          allure_history: ${{ env.PROJECT }}/${{ env.MODULE }}/allure-history
          keep_reports:  ${{ env.KEEP }}   # keep only N most-recent reports

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Extract summary (multiline-safe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract Allure summary
        id: summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [[ -f "$SUMMARY_FILE" ]]; then
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            jq -r '
              .statistic |
              "ğŸ§ª Total: \(.total)
                âœ… Passed: \(.passed)
                âŒ Failed: \(.failed)
                âš ï¸ Broken: \(.broken)
                ğŸš« Skipped: \(.skipped)"
            ' "$SUMMARY_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=Allure summary not found" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Publish to GitHub Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4   # â† v4 is the current tag
        if: always()
        with:
          github_token:   ${{ secrets.GITHUB_TOKEN }}
          publish_dir:    allure-history          # <- just the history folder itself
          destination_dir: ${{ env.PROJECT }}/${{ env.MODULE }}   # <- ğŸ“Œ NEW
          keep_files:     true                    # keeps other projects/modules
          commit_message: "ci: Allure report for run #${{ github.run_number }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. Wait for the site to go live â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Wait for GitHub Pages
        if: always()
        run: |
          URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.PROJECT }}/${{ env.MODULE }}/${{ github.run_number }}/"
          echo "Report URL: $URL"
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            [ "$STATUS" = 200 ] && { echo "Live ğŸš€"; exit 0; }
            echo "Status $STATUS â€“ retryingâ€¦"; sleep 10
          done
          echo "::warning ::Page still not up after 2 min"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. PR comment (only on PRs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment on PR with link & summary
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸ”— **Allure Test Report:** [View](
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.PROJECT }}/${{ env.MODULE }}/${{ github.run_number }}/)

            **Test Summary**
            ${{ steps.summary.outputs.summary }}