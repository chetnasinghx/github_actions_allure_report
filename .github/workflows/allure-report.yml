name: Run Tests and Publish Allure Report with History

on:
  push:
    branches: [main]
  pull_request:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  GLOBAL CONFIG  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  PRODUCT: product          # top-level directory (e.g. product, projectX)
  MODULE: api               # sub-directory   (e.g. api, web, app)
  PYTHON_VERSION: "3.10"
  ALLURE_VERSION: "2.34.0"

permissions:
  contents: write            # push to gh-pages
  pull-requests: write       # post PR comment
  id-token: write            # required by gh-pages action

# cancel older runs on same branch/PR
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SOURCE & PYTHON SETUP  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§¾ Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0                                # full history (coverage, links)

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: pip                                    # speed-up subsequent runs

    - name: ğŸ“¦ Install dependencies
      run: |
        set -e
        REQ_FILE="${PRODUCT}/${MODULE}/requirements.txt"
        python -m pip install --upgrade pip
        if [[ -f "$REQ_FILE" ]]; then
          echo "Installing deps from $REQ_FILE"
          pip install -r "$REQ_FILE"
        else
          echo "::error::requirements.txt not found at $REQ_FILE"
          exit 1
        fi
        pip install allure-pytest                      # guarantees allure markers

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  TEST EXECUTION  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§ª Run pytest (Allure)
      id: run_tests
      continue-on-error: true                          # still build report on failure
      run: |
        set -eo pipefail
        TEST_DIR="${PRODUCT}/${MODULE}/tests"
        [[ -d "$TEST_DIR" ]] || { echo "::error::No tests in $TEST_DIR"; exit 1; }
        pytest "$TEST_DIR" -v --alluredir=allure-results

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  HISTORY RESTORE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“‚ Checkout gh-pages (for history)
      if: always()
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages

    - name: â™»ï¸ Restore previous Allure history
      if: always()
      run: |
        HISTORY_DIR="gh-pages/${PRODUCT}/${MODULE}/last-history"
        if [[ -d "$HISTORY_DIR" ]]; then
          mkdir -p allure-results/history
          cp -r "$HISTORY_DIR/." allure-results/history/
          echo "âœ… History copied from $HISTORY_DIR"
        else
          echo "â„¹ï¸ No history found for this module."
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ALLURE CLI  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â˜• Set up Java (Allure CLI needs it)
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: "17"

    - name: âš™ï¸ Install Allure CLI
      run: |
        wget -qO allure.tgz "https://repo1.maven.org/maven2/io/qameta/allure/allure-commandline/${ALLURE_VERSION}/allure-commandline-${ALLURE_VERSION}.tgz"
        tar -xzf allure.tgz
        echo "${PWD}/allure-${ALLURE_VERSION}/bin" >> "$GITHUB_PATH"

    - name: ğŸ§± Generate Allure report
      if: always()
      run: |
        allure generate allure-results --clean -o allure-report

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SAVE HISTORY  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ’¾ Persist history for next run
      if: always()
      run: |
        mkdir -p gh-pages/${PRODUCT}/${MODULE}/last-history
        cp -r allure-report/history/. gh-pages/${PRODUCT}/${MODULE}/last-history/

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  COPY REPORT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Copy report to versioned folder
      if: always()
      run: |
        TARGET="gh-pages/${PRODUCT}/${MODULE}/${{ github.run_number }}"
        mkdir -p "$TARGET"
        cp -r allure-report/. "$TARGET/"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  DEPLOY PAGES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸš€ Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages
        publish_branch: gh-pages
        commit_message: "ci: Allure report ${PRODUCT}/${MODULE} run #${{ github.run_number }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  WAIT FOR PAGES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â³ Wait for GitHub Pages to become available
      if: always()
      run: |
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${PRODUCT}/${MODULE}/${{ github.run_number }}/"
        echo "Waiting for GitHub Pagesâ€¦"
        echo "Report link: $REPORT_URL"
        for i in {1..10}; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$REPORT_URL")
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Site is live!"
            break
          else
            echo "Status $HTTP_STATUS â€” retry in 10 s ($i/10)â€¦"
            sleep 10
          fi
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SUMMARY & PR COMMENT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“Š Extract Allure summary
      if: always()
      id: summary
      run: |
        SUMMARY_FILE="allure-report/widgets/summary.json"
        NEWLINE=$'\n'
        if [[ -f "$SUMMARY_FILE" ]]; then
          STATS=$(jq -r '.statistic |
            "ğŸ§ª Total: \(.total)\nâœ… Passed: \(.passed)\nâŒ Failed: \(.failed)\nâš ï¸ Broken: \(.broken)\nğŸš« Skipped: \(.skipped)"' "$SUMMARY_FILE")
          echo "result<<EOF${NEWLINE}${STATS}${NEWLINE}EOF" >> "$GITHUB_OUTPUT"
        else
          echo "result<<EOF${NEWLINE}âš ï¸ Allure summary not found${NEWLINE}EOF" >> "$GITHUB_OUTPUT"
        fi

    - name: ğŸ’¬ Comment test summary on PR
      if: ${{ github.event_name == 'pull_request' }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ğŸ”— **Allure Report:** [Open Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.PRODUCT }}/${{ env.MODULE }}/${{ github.run_number }}/)

          **Test Summary**
          ```
              ${{ steps.summary.outputs.result }}
          ```