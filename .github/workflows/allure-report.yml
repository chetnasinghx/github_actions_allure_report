name: Run tests and publish report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          python -m pytest tests/ -v --alluredir=allure-results

      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build test report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: allure-results

      - name: Publish test report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          commit_message: "ci: allure report for run ${{ github.run_number }}

                      View the report for this run here: https://${{ github.event.repository.owner.login }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/"

      - name: Wait for GitHub Pages Deployment and Add PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        env:
          REPORT_URL: https://${{ github.event.repository.owner.login }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.pull_request.number;
            const reportUrl = process.env.REPORT_URL;
            const maxRetries = 10;
            const retryInterval = 5000; // 5 seconds

            console.log('Waiting for GitHub Pages deployment...');

            for (let i = 0; i < maxRetries; i++) {
              try {
                const { data: commit } = await github.rest.repos.getCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'gh-pages'
                });

                const commitDate = new Date(commit.commit.author.date);
                const now = new Date();
                const diffInSeconds = (now.getTime() - commitDate.getTime()) / 1000;

                // Check if the last commit on gh-pages was within a recent timeframe (e.g., 30 seconds)
                if (diffInSeconds < 30) {
                  console.log('GitHub Pages deployment likely in progress or complete.');
                  const message = `üîç Allure Test Report: [View Report](${reportUrl})`;
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: message
                  });
                  return; // Exit the loop
                } else {
                  console.log(`Last gh-pages commit was ${diffInSeconds} seconds ago. Waiting...`);
                }
              } catch (error) {
                console.error('Error checking gh-pages commit:', error);
              }

              await new Promise(resolve => setTimeout(resolve, retryInterval));
            }

            console.log('Max retries reached. Adding comment without guaranteed deployment.');
            const finalMessage = `‚ö†Ô∏è Allure Test Report: [View Report](${reportUrl}) - Deployment status could not be reliably determined.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: finalMessage
            });