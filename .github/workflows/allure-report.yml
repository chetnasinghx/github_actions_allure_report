name: Run Tests and Publish Allure Report with History

on:
  push:
    branches: [main]
  pull_request:

# >>>>>>>>>>>>>>>>>>>>>>>>>  CONFIG  <<<<<<<<<<<<<<<<<<<<<<<<<
env:
  PRODUCT: product          # top-level directory
  MODULE: api               # api | web | app ...
  PYTHON_VERSION: "3.10"
  ALLURE_VERSION: "2.34.0"
# -----------------------------------------------------------

permissions:
  contents: write           # push to gh-pages
  pull-requests: write      # leave PR comments
  id-token: write           # required by gh-pages action

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # abort older runs of same ref

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
    # --------------------------------------------------------------------
    - name: ğŸ§¾ Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0        # full history for coverage / links

    # --------------------------------------------------------------------
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"

    # --------------------------------------------------------------------
    - name: ğŸ“¦ Install dependencies
      run: |
        set -e
        REQ_FILE="${PRODUCT}/${MODULE}/requirements.txt"
        python -m pip install --upgrade pip
        if [[ -f "$REQ_FILE" ]]; then
          echo "Installing deps from: $REQ_FILE"
          pip install -r "$REQ_FILE"
        else
          echo "::error::requirements.txt not found at $REQ_FILE"
          exit 1
        fi
        pip install allure-pytest           # ensures allure markers are present

    # --------------------------------------------------------------------
    - name: ğŸ§ª Run pytest (with Allure results)
      id: run_tests
      continue-on-error: true              # keep pipeline alive for report
      run: |
        set -eo pipefail
        TEST_DIR="${PRODUCT}/${MODULE}/tests"
        [[ -d "$TEST_DIR" ]] || { echo "::error::Tests not found in $TEST_DIR"; exit 1; }
        pytest "$TEST_DIR" -v --alluredir=allure-results

    # --------------------------------------------------------------------
    - name: ğŸ“‚ Checkout gh-pages branch (for history & publish)
      uses: actions/checkout@v4
      if: always()
      with:
        ref: gh-pages
        path: gh-pages

    # --------------------------------------------------------------------
    - name: â™»ï¸ Restore previous Allure history
      if: always()
      run: |
        HISTORY_DIR="gh-pages/${PRODUCT}/${MODULE}/last-history"
        if [[ -d "$HISTORY_DIR" ]]; then
          mkdir -p allure-results/history
          cp -r "${HISTORY_DIR}/." allure-results/history/
          echo "âœ… Restored history from $HISTORY_DIR"
        else
          echo "â„¹ï¸ No history found â€“ first run for this module."
        fi

    # --------------------------------------------------------------------
    - name: â˜• Add Java (needed by Allure CLI)
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: "17"

    - name: âš™ï¸ Install Allure CLI ${{ env.ALLURE_VERSION }}
      run: |
        wget -qO allure.tgz "https://repo1.maven.org/maven2/io/qameta/allure/allure-commandline/${ALLURE_VERSION}/allure-commandline-${ALLURE_VERSION}.tgz"
        tar -xzf allure.tgz
        echo "${PWD}/allure-${ALLURE_VERSION}/bin" >> "$GITHUB_PATH"

    # --------------------------------------------------------------------
    - name: ğŸ§± Generate Allure report
      if: always()
      run: |
        allure generate allure-results --clean -o allure-report

    - name: ğŸ’¾ Save history for next pipeline
      if: always()
      run: |
        mkdir -p gh-pages/${PRODUCT}/${MODULE}/last-history
        cp -r allure-report/history/. gh-pages/${PRODUCT}/${MODULE}/last-history/

    # --------------------------------------------------------------------
    - name: ğŸ“¤ Copy report to versioned folder
      if: always()
      run: |
        TARGET="gh-pages/${PRODUCT}/${MODULE}/${{ github.run_number }}"
        mkdir -p "$TARGET"
        cp -r allure-report/. "$TARGET/"

    # --------------------------------------------------------------------
    - name: ğŸš€ Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages
        publish_branch: gh-pages
        commit_message: "ci: Allure report ${PRODUCT}/${MODULE} run #${{ github.run_number }}"

    # --------------------------------------------------------------------
    - name: ğŸ“Š Extract Allure summary
      if: always()
      id: summary
      run: |
        SUMMARY_FILE="allure-report/widgets/summary.json"
        if [[ -f "$SUMMARY_FILE" ]]; then
          NEWLINE=$'\n'
          STATS=$(jq -r \
            '.statistic | 
            "ğŸ§ª Total: \(.total)\nâœ… Passed: \(.passed)\nâŒ Failed: \(.failed)\nâš ï¸ Broken: \(.broken)\nğŸš« Skipped: \(.skipped)"' \
            "$SUMMARY_FILE")
          # encode newlines for output
          echo "result<<EOF${NEWLINE}${STATS}${NEWLINE}EOF" >> $GITHUB_OUTPUT
        else
          echo "result<<EOF${NEWLINE}âš ï¸ Allure summary not found${NEWLINE}EOF" >> $GITHUB_OUTPUT
        fi

    # --------------------------------------------------------------------
    - name: ğŸ’¬ Comment test summary on PR
      if: ${{ github.event_name == 'pull_request' }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ğŸ”— **Allure Report:** [Open Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.PRODUCT }}/${{ env.MODULE }}/${{ github.run_number }}/)

          **Test Summary**
          ```
          ${{ steps.summary.outputs.result }}
          ```